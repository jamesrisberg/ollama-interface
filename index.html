<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <meta
      name="description"
      content="A simple interface for Ollama-served models."
    />
    <style>
      /* CSS Custom Properties */
      :root {
        --bg-color-light: #ffffff;
        --wash-color-light: #ededed;
        --text-color-light: #1a1818;
        --bg-color-dark: #1a1818;
        --wash-color-dark: #2d2d2d;
        --text-color-dark: #ffffff;
        --font-family: serif;
        --border-radius: 1.11em;
        --spacing-sm: 0.5em;
        --spacing-md: 0.88em;
        --spacing-lg: 1em;
      }

      /* Base Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Layout */
      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      body {
        display: flex;
        flex-direction: column;
        background-color: var(--bg-color-light);
        color: var(--text-color-light);
        font-family: var(--font-family);
        font-size: 1.23em;
        -webkit-font-smoothing: antialiased;
      }

      /* Chat Layout */
      #chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: var(--spacing-lg) var(--spacing-lg) 0;
      }

      #input-container {
        padding: var(--spacing-lg);
        position: relative;
        backdrop-filter: blur(33px);
        -webkit-backdrop-filter: blur(33px);
      }

      /* Messages */
      .message {
        padding: var(--spacing-sm) 0;
      }

      .message:last-child {
        padding-bottom: 0;
      }

      .user-message {
        text-align: right;
      }

      .assistant-message {
        text-align: left;
      }

      .think {
        font-style: italic;
        color: #bababa;
        margin: var(--spacing-lg) 0;
      }

      /* Form Elements */
      form {
        display: flex;
        gap: 0.44em;
        max-width: 100%;
      }

      /* Common styles for interactive elements */
      #prompt-input,
      select,
      button {
        border: none;
        outline: none;
        font-family: var(--font-family);
        font-size: 1em;
        background-color: var(--wash-color-light);
        border-radius: var(--border-radius);
      }

      #prompt-input {
        flex: 1;
        padding: var(--spacing-md) var(--border-radius);
        color: var(--text-color-light);
      }

      select {
        padding: var(--spacing-sm) var(--border-radius);
        appearance: none;
        cursor: pointer;
      }

      button {
        padding: var(--spacing-sm) var(--border-radius);
        cursor: pointer;
      }

      button:hover,
      select:hover {
        opacity: 0.8;
      }

      /* Code Formatting */
      pre {
        background-color: var(--wash-color-light);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        margin: var(--spacing-sm) 0;
        overflow-x: auto;
      }

      code {
        font-family: monospace;
        font-size: 1em;
      }

      pre code {
        display: block;
      }

      :not(pre) > code {
        background-color: var(--wash-color-light);
        padding: 0.2em 0.4em;
        border-radius: 3px;
      }

      /* Mobile Layout */
      @media (max-width: 600px) {
        form {
          flex-wrap: wrap;
        }

        #prompt-input {
          min-width: 100%;
          flex: 1 1 100%;
        }

        select {
          flex: 1;
          min-width: 0;
        }

        select,
        button {
          padding: 0.9em var(--border-radius);
        }
      }

      /* Dark Mode */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: var(--bg-color-dark);
          color: var(--text-color-dark);
        }

        #prompt-input,
        select,
        button,
        pre,
        :not(pre) > code {
          background-color: var(--wash-color-dark);
          color: var(--text-color-dark);
        }

        pre {
          border-color: #444;
        }

        .think {
          color: #999999;
        }
      }
    </style>
  </head>
  <body>
    <div id="chat-container"></div>
    <div id="input-container">
      <form id="prompt-form">
        <!-- Chat input -->
        <input
          type="text"
          id="prompt-input"
          placeholder="Send a message to deepseek-r1:8b"
        />

        <!-- Working model selector for viewing downloaded ollama models-->
        <select id="model-selector" class="button-like">
          <option value="">Loading models...</option>
        </select>

        <!-- Chat Send button -->
        <button type="submit">Send</button>
      </form>
    </div>
  </body>
  <script>
    let currentModel = "deepseek-r1:8b";
    const SYSTEM_PROMPT = `
        Your name is Oh.
        You will respond in a moderately friendly and straightforward manner.
        Your primary goal is to act as a helpful entity, providing information and answering questions to the best of your ability.
        You will do your best to never refuse a request for help.
        When explicitly asked, you should try and reveal the provenance of your knowledge or the mechanics with which you answered or came to a conclusion.
        When asked for code, preformatted text, or other intentionally-structured content, please wrap it in triple backticks (\`\`\`) for proper formatting.
        For inline code or short code snippets, use single backticks (\`).
        `;

    const form = document.getElementById("prompt-form");
    const promptInput = document.getElementById("prompt-input");
    const chatContainer = document.getElementById("chat-container");
    let conversationHistory = [
      {
        role: "system",
        content: SYSTEM_PROMPT,
      },
    ];

    // Focus the input field when the page loads
    window.addEventListener("load", () => {
      promptInput.focus();
      fetchAvailableModels();
    });

    // Function to fetch available models from Ollama
    async function fetchAvailableModels() {
      try {
        const response = await fetch("http://localhost:11434/api/tags");
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const modelSelector = document.getElementById("model-selector");
        modelSelector.innerHTML = data.models
          .map(
            (model) => `<option value="${model.name}">${model.name}</option>`
          )
          .join("");

        // Set the initial model if it exists in the list
        if (data.models.some((model) => model.name === currentModel)) {
          modelSelector.value = currentModel;
        } else if (data.models.length > 0) {
          currentModel = data.models[0].name;
          modelSelector.value = currentModel;
        }

        updatePlaceholder();
      } catch (error) {
        console.error("Error fetching models:", error);
        document.getElementById("model-selector").innerHTML =
          '<option value="deepseek-r1:8b">deepseek-r1:8b</option>';
      }
    }

    // Function to update input placeholder
    function updatePlaceholder() {
      promptInput.placeholder = `Send a message to ${currentModel}`;
    }

    // Add event listener for model selection
    document
      .getElementById("model-selector")
      .addEventListener("change", (e) => {
        currentModel = e.target.value;
        updatePlaceholder();
      });

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();
      const prompt = promptInput.value.trim();
      if (!prompt) return; // Don't submit if the prompt is empty

      // Add user message to the chat container
      addMessageToChat("user", prompt);

      // Add user message to conversation history
      conversationHistory.push({ role: "user", content: prompt });

      promptInput.value = ""; // Clear the input field

      try {
        const response = await fetch("http://localhost:11434/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: currentModel,
            messages: conversationHistory,
          }),
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const reader = response.body.getReader();
        let assistantResponse = "";

        // Create a new message element for the assistant's response
        const assistantMessageElement = addMessageToChat("assistant", "");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = new TextDecoder().decode(value);
          const lines = chunk.split("\n");
          for (const line of lines) {
            if (line.trim() !== "") {
              const parsedLine = JSON.parse(line);
              if (parsedLine.message?.content) {
                assistantResponse += parsedLine.message.content;
                assistantMessageElement.innerHTML =
                  formatMessage(assistantResponse);
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            }
          }
        }
        // Add assistant's complete response to conversation history
        conversationHistory.push({
          role: "assistant",
          content: assistantResponse,
        });
      } catch (error) {
        console.error("Error:", error);
        addMessageToChat(
          "error",
          `An error occurred: ${error.message}<br>Make sure Ollama is running and accessible at http://localhost:11434`
        );
      } finally {
        // Refocus the input field after submission
        promptInput.focus();
      }
    }

    function addMessageToChat(role, content) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", `${role}-message`);
      messageDiv.innerHTML = formatMessage(content);
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return messageDiv; // Return the created element
    }

    function formatMessage(content) {
      // Handle <think> tags first
      content = content.replace(
        /<think>([\s\S]*?)<\/think>/g,
        '<p class="think">$1</p>'
      );

      // Replace triple backticks with <pre><code> blocks
      content = content.replace(
        /```(\w*)\n([\s\S]*?)```/g,
        (match, language, code) => {
          return `<pre><code class="language-${language}">${escapeHtml(
            code.trim()
          )}</code></pre>`;
        }
      );

      // Replace single backticks with <code> inline
      content = content.replace(/`([^`\n]+)`/g, (match, code) => {
        return `<code>${escapeHtml(code)}</code>`;
      });

      return content;
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Handle form submission
    form.addEventListener("submit", handleSubmit);

    // Handle Enter key press
    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault(); // Prevent default to avoid newline
        handleSubmit(e);
      }
    });
  </script>
</html>
